import { Steps, Tabs } from 'nextra/components';

# 在 Docker 中运行 Xone Chain 节点

本指南提供了在 Docker 容器中运行 Xone Chain 节点的分步流程。此方法适合偏好使用容器化应用以简化管理、部署和扩展的用户。

<Steps>
### 1. 前提条件

1.  **操作系统**: Ubuntu 22.04 或 24.04
2.  **节点初始化已完成**

    *   您已在本地或主机上运行过 `xoned init` 并替换了 `genesis.json` / `config.toml` / `app.toml`。
    *   默认数据目录为 `/home/ubuntu/.xone`（可根据需要修改）。
3.  **主机权限**

    *   `ubuntu` 用户（或您选择的用户）必须对 `/home/ubuntu/.xone` 具有读写权限。
    *   您需要 `sudo` 权限来安装软件和管理 Docker。


### 2. 安装 Docker

```bash showLineNumbers copy
# 更新软件包列表
sudo apt update

# 添加 Docker 官方 GPG 密钥
arch=$(dpkg --print-architecture)
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -

# 添加 Docker 稳定版仓库
sudo add-apt-repository \
  "deb [arch=${arch}] https://download.docker.com/linux/ubuntu \
  $(lsb_release -cs) stable"

# 安装 Docker Engine
sudo apt update
sudo apt install -y docker-ce

# 启用并启动 Docker 服务
sudo systemctl enable docker
sudo systemctl start docker
sudo systemctl status docker
```

> **提示:** 要允许非 root 用户（例如 `ubuntu`）在不使用 sudo 的情况下运行 Docker 命令，请将其添加到 `docker` 用户组：
>
> ```bash showLineNumbers copy
> sudo usermod -aG docker ubuntu
> ```


### 3. 创建启动脚本

在任何目录下，创建一个名为 `docker_run.sh` 的文件并粘贴以下内容：

```bash showLineNumbers copy
#!/bin/sh

# —— 动态获取最新版本号  ——
LATEST_VERSION=$(curl -s https://xone-mainnet-files.s3.ap-southeast-1.amazonaws.com/latest-version.txt)

# —— 根据需要修改以下变量 ——
IMAGE_URL="xonechain/xoned:${LATEST_VERSION}" # 节点镜像和版本（自动更新）
CONTAINER_NAME='xone-node' # 容器名称
DATA_DIR='/home/ubuntu/.xone' # 主机数据目录
RPC_PORT_HTTP=8545 # JSON-RPC HTTP 端口
RPC_PORT_WS=8546 # JSON-RPC WebSocket 端口
P2P_PORT=26656 # P2P 端口
P2P_RPC_PORT=26657 # P2P RPC 接口端口
PEER_PORT=26658 # 备用 P2P 端口
PROMETHEUS_PORT=26660 # Prometheus 指标端口
REST_PORT=1317 # REST API 端口
METRICS_PORT=9090 # Prometheus 导出器端口
GRPC_METRICS_PORT=9091 # gRPC 导出器端口
echo "Using image version: ${LATEST_VERSION}"

# 移除任何已存在的容器
docker rm -f $CONTAINER_NAME 2>/dev/null

# 运行容器
docker run -d \
  --name $CONTAINER_NAME \
  --restart always \
  -v $DATA_DIR:/root/.xone \
  -p $RPC_PORT_HTTP:8545 \
  -p $RPC_PORT_WS:8546 \
  -p $P2P_PORT:26656 \
  -p $P2P_RPC_PORT:26657 \
  -p $PEER_PORT:26658 \
  -p $PROMETHEUS_PORT:26660 \
  -p $REST_PORT:1317 \
  -p $METRICS_PORT:9090 \
  -p $GRPC_METRICS_PORT:9091 \
  $IMAGE_URL \
  xoned start \
    --pruning=nothing \
    --json-rpc.api eth,txpool,personal,net,debug,web3,miner \
    --api.enable \
    --json-rpc.enable \
    --json-rpc.address 0.0.0.0:8545 \
    --json-rpc.ws-address 0.0.0.0:8546
```

> **注意:**
>
> *   `-v $DATA_DIR:/root/.xone`: 将主机数据目录挂载到容器中以实现持久化。
> *   `--restart always`: 确保容器在故障或主机重启时自动重启。
> *   `--pruning=nothing`: 保留完整的区块历史记录（可根据需要更改为 `syncable`、`default` 等）。
> *   `--json-rpc.api`: 指定要启用的 RPC 模块。
> *   调整端口映射以适应您的防火墙规则和网络拓扑。


### 4. 设置权限并启动

```bash showLineNumbers copy
# 使脚本可执行
chmod +x docker_run.sh

# R使用 sudo 运行脚本
sudo ./docker_run.sh
```

> 要更改数据目录或端口，请更新脚本顶部的变量——无需进行其他编辑。


### 5. 检查容器状态和日志

```bash showLineNumbers copy
# 列出正在运行的容器
docker ps

# 实时跟踪日志
sudo docker logs -f xone-node
```


### 6. 常用操作

*   **升级镜像**

  ```bash showLineNumbers copy
  # 拉取最新的标签
  docker pull xonechain/xoned:latest

  # 重新运行启动脚本
  sudo ./docker_run.sh
  ```
* **进入容器进行调试**

  ```bash showLineNumbers copy
  docker exec -it xone-node /bin/sh
  ```
* **清除旧数据**

  ```bash showLineNumbers copy
  # 停止并移除容器
  docker rm -f xone-node

  # 删除数据目录
  rm -rf /home/ubuntu/.xone

  # 重新初始化 / 复制配置文件，然后重新运行脚本
  ./docker_run.sh
  ```

</Steps>
完成这些步骤后，您的 Xone Chain 节点将在 Docker 容器中运行，具有自动重启、持久化存储和灵活的端口映射功能，从而实现高效运维和快速迭代。